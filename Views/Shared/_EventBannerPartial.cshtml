@model PaginationResponse<HaBuddies.Models.Event>
@using HaBuddies.Constants
@using Newtonsoft.Json;

@functions {
    public bool IsOwnedEvent(dynamic userObj, HaBuddies.Models.Event evt) {
        if (userObj != null) {
            if (evt.OwnerId == userObj.Id.ToString()) return true;
        }
        return false;
    }

    public bool IsJoinable(dynamic userObj, HaBuddies.Models.Event evt) {
        if (userObj != null) {
            if (userObj.Age >= evt.MinAgeRequirement && userObj.Age <= evt.MaxAgeRequirement && 
                evt.GenderRequirement.Any(s => s.Contains(userObj.Gender.ToString()))) {
                return true;
            }
        }
        return false;
    }

    public bool IsCurrentlyJoined(dynamic userObj, HaBuddies.Models.Event evt) {
        if (userObj != null) {
            if (evt.SubscribersId.Any(s => s.Contains(userObj.Id.ToString()))) return true;
        }
        return false;
    }
}

@{
    string userExist = ViewContext.HttpContext.Session.GetString("user")!;
    dynamic userObject = null!;
    if (userExist != null) {
        userObject = JsonConvert.DeserializeObject(userExist)!;
    }
}

@if (Model.Count > 0) {
    @foreach (HaBuddies.Models.Event evt in Model.Data)
    {
        if (evt.IsOpen == true) {
            var category = evt.Category;
            int currentEnroll = evt.SubscribersId.Count + evt.QueueId.Count;

            bool selfOwned = IsOwnedEvent(userObject, evt);
            bool canJoin = IsJoinable(userObject, evt);
            bool currentlyJoin = IsCurrentlyJoined(userObject, evt);
            
            <div class="banner" id="@evt.Id">
                <a draggable="false" asp-controller="Event" asp-action="Details" asp-route-id="@evt.Id">
                    <div class="evt-heading">
                        <div class="category" style="background-color: @Category.GetColorHex(category)">
                            @Html.Raw(Category.GetIconHtml(category))
                            <span class="evt-category">@category</span>
                        </div>
                        <h2 class="evt-title">@evt.Title</h2>
                        <span class="evt-enrollsize @(currentEnroll<evt.EnrollSize?"vacant":"full")">
                            @currentEnroll/@evt.EnrollSize <i class="fa-solid fa-user-group"></i>
                        </span>
                        <div class="owner">
                            <div class="owner-picture">
                                <img alt="Owner picture" src="~/img/default.jpg" draggable="false">
                            </div>
                            @* <span class="owner-name">@evt.Owner.Name @evt.Owner.Surname</span> *@
                            <span class="owner-name">Somethinglong SomethinglongToo</span>
                        </div>
                    </div>
                    <div class="evt-body">
                        <span class="evt-description">@evt.Description</span>
                        <span class="evt-enddate">Close Date<br>@evt.EndDate.ToShortDateString()</span>
                    </div>
                </a>
                @if (!selfOwned) {
                    <button type="button" class="evt-join @(canJoin?"active":"") @(currentlyJoin?"leave":"join")" onclick=@(canJoin?"myFunction(this)":"")>
                        @if (currentlyJoin) {
                            <text>ออก</text>
                        }
                        else {
                            <text>เข้าร่วม</text>
                        }
                    </button>
                }
            </div>
        }
    }
    <script>
        function myFunction(element) {
            var bannerId = element.parentElement.id;
            if (element.classList.contains("join")) {
                alert("Joined " + bannerId);
            }
            else {
                alert("Left " + bannerId);
            }
        }
    </script>
}
else {
    <div class="no-event">
        <img src="https://img.freepik.com/free-vector/group-therapy-illustration-concept_52683-45727.jpg?t=st=1709623373~exp=1709626973~hmac=78df7e8d67f4c5f6b0d06d0113b240ce820bf4d30f74051aaf195c505371a8d0" alt="no_event">
        <h2>No events yet</h2>
        <p>It has been quiet recently. Let's create some new events!</p>
        <a class="create-event" asp-area="" asp-controller="Event" asp-action="Create">Create event</a>
    </div>
}